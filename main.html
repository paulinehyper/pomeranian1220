<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Smart Schedule - Main</title>
  <style>
    body { margin: 0; padding: 0; background: transparent; font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; overflow: hidden; }
    .widget-home { position: fixed; top: 40px; left: 40px; width: 520px; height: 600px; background: #f8fffd; border-radius: 18px; box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #eef2f1; }
    .widget-home-header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 2px 8px #00b49a11; font-size: 1.15em; font-weight: bold; color: #00b49a; -webkit-app-region: drag; flex-shrink: 0; }
    .widget-home-header * { -webkit-app-region: no-drag; }
    
    .widget-home-sidebar { width: 56px; height: 100%; background: #ffffff; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; gap: 16px; padding-top: 20px; flex-shrink: 0; }
    .sidebar-btn { background: transparent; border: none; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #00b49a; transition: 0.2s; }
    .sidebar-btn:hover { background: #e6fffb; }
    .sidebar-btn svg { width: 22px; height: 22px; stroke: currentColor; }

    .widget-content-area { display: flex; flex: 1; overflow: hidden; }
    .widget-home-main { padding: 20px; flex: 1; overflow-y: auto; background: #f8fffd; }
    
    /* 할일 카드 스타일 */
    .todo-card { position: relative; background: #fff; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0, 180, 154, 0.08); border-left: 5px solid #00b49a; transition: 0.2s; cursor: pointer; }
    .todo-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 180, 154, 0.12); }
    .todo-card.completed { border-left-color: #bbb !important; background: #f2f2f2 !important; opacity: 0.7; }
    .todo-card.completed .todo-content { text-decoration: line-through; color: #888; }

    .todo-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .todo-content-wrapper { flex: 1; }
    .todo-content { font-weight: 600; color: #333; font-size: 1em; line-height: 1.4; display: block; }
    .todo-source { font-size: 0.75em; color: #00b49a; font-weight: bold; margin-bottom: 4px; display: block; }
    
    .todo-actions { display: flex; align-items: center; gap: 6px; }
    .action-btn { background: #fff; border: 1.2px solid #ff5e5e; color: #ff5e5e; border-radius: 6px; padding: 2px 7px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .action-btn:hover { background: #ff5e5e; color: #fff; }
    .delete-icon-btn { background: transparent; border: none; cursor: pointer; padding: 0; align-items: center; }

    .todo-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .todo-date { font-size: 0.8em; color: #777; background: #f0fcf9; padding: 2px 8px; border-radius: 4px; }
    
    .d-day-badge { font-size: 0.75em; font-weight: bold; padding: 2px 8px; border-radius: 6px; color: #fff; }
    .d-day-active { background: #00b49a; }
    .d-day-urgent { background: #ff5e5e; }
    .d-day-passed { background: #ddd; color: #777; }

    /* 입력 섹션 */
    .input-section { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eef2f1; }
    .input-row { display: flex; gap: 6px; }
    .todo-input { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1.5px solid #7be2c5; outline: none; }
    .date-input { width: 120px; border-radius: 8px; border: 1.5px solid #7be2c5; padding: 0 5px; }
    .add-btn { background: #00b49a; color: #fff; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* 키워드 뱃지 */
    .kw-badge { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span>Smart Schedule</span>
      <button id="closeBtn" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">&times;</button>
    </div>

    <div class="widget-content-area">
      <div class="widget-home-sidebar">
        <button class="sidebar-btn" title="홈" data-type="main">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </button>
        <button class="sidebar-btn" title="키워드" data-type="keyword">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3-3.5 3.5z"/></svg>
        </button>
        <button class="sidebar-btn" title="휴지통" data-type="trash">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        </button>
        <div style="flex:1;"></div>
      </div>

      <div class="widget-home-main" id="widgetHomeMain"></div>
    </div>
  </div>

  <script>
    const widgetMain = document.getElementById('widgetHomeMain');

    // [유틸] D-Day 계산
    function getDDay(deadline) {
      if (!deadline || deadline === '없음') return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const target = new Date(deadline); target.setHours(0,0,0,0);
      if (isNaN(target)) return null;
      const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return { text: "오늘까지", class: "d-day-urgent" };
      if (diffDays > 0) return { text: `D-${diffDays}`, class: diffDays <= 3 ? "d-day-urgent" : "d-day-active" };
      return { text: `지남`, class: "d-day-passed" };
    }

    // [유틸] 카드 HTML 생성
    function createCardHtml(item, isEmail = false) {
      const dday = getDDay(item.deadline);
      const isDone = Number(item.todo_flag) === 2;
      const taskId = item.id;
      const title = isEmail ? (item.subject || '(제목 없음)') : (item.task || item.content);
      
      return `
        <div class="todo-card ${isDone ? 'completed' : ''}" data-id="${taskId}" data-is-email="${isEmail}">
          <div class="todo-top">
            <div class="todo-content-wrapper">
              ${isEmail ? `<span class="todo-source">Email: ${item.from_addr || '알 수 없음'}</span>` : ''}
              <span class="todo-content">${title}</span>
            </div>
            <div class="todo-actions">
              ${!isDone ? `<button class="action-btn exclude-btn">제외</button>` : ''}
              <button class="delete-icon-btn" style="${isDone ? 'display:flex;' : 'display:none;'}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="todo-bottom">
            <div class="todo-info-group">
              <span class="todo-date">${item.deadline && item.deadline !== '없음' ? '마감: ' + item.deadline : '마감 없음'}</span>
              ${dday && !isDone ? `<span class="d-day-badge ${dday.class}">${dday.text}</span>` : ''}
            </div>
          </div>
        </div>`;
    }

    // 카드 이벤트 바인딩
    function bindCardEvents(container) {
      container.querySelectorAll('.todo-card').forEach(card => {
        const id = Number(card.getAttribute('data-id'));
        const isEmail = card.getAttribute('data-is-email') === 'true';

        // 완료 토글
        card.querySelector('.todo-content').onclick = async () => {
          const isDone = card.classList.contains('completed');
          const nextFlag = isDone ? 1 : 2;
          if (isEmail) await window.electronAPI.setMailComplete(id, nextFlag);
          else await window.electronAPI.setTodoComplete(id, nextFlag);
          refreshAll();
        };

        // 휴지통으로 이동
        const delBtn = card.querySelector('.delete-icon-btn');
        if (delBtn) {
          delBtn.onclick = async (e) => {
            e.stopPropagation();
            if (isEmail) await window.electronAPI.setMailComplete(id, 3);
            else await window.electronAPI.setTodoComplete(id, 3);
            refreshAll();
          };
        }

        // 키워드 제외
        const exBtn = card.querySelector('.exclude-btn');
        if (exBtn) {
          exBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm('이 항목을 제외하고 앞으로 동일한 메일을 차단할까요?')) {
              await window.electronAPI.excludeTodo(id, isEmail);
              refreshAll();
            }
          };
        }
      });
    }

    // 메인 리스트 새로고침
    async function refreshAll() {
      const userContainer = document.getElementById('todoListContainer');
      const emailContainer = document.getElementById('emailTodoListContainer');
      if (!userContainer || !emailContainer) return;

      const userTodos = await window.electronAPI.getTodos();
      userContainer.innerHTML = (userTodos && userTodos.length) 
        ? userTodos.map(t => createCardHtml(t, false)).join('')
        : '<p style="text-align:center;color:#bbb;padding:10px;">등록된 할일이 없습니다.</p>';

      const emailTodos = await window.electronAPI.getTodoEmails();
      emailContainer.innerHTML = (emailTodos && emailTodos.length)
        ? emailTodos.map(e => createCardHtml(e, true)).join('')
        : '<p style="text-align:center;color:#bbb;padding:10px;">이메일 할일이 없습니다.</p>';

      bindCardEvents(userContainer);
      bindCardEvents(emailContainer);
    }

    // 1. 메인 페이지
    async function renderMainPage() {
      widgetMain.innerHTML = `
        <h2 style="color:#00b49a;margin:0 0 12px 0;font-size:1em;font-weight:800;">새 할일</h2>
        <div class="input-section">
          <div class="input-row">
            <input type="text" id="todoInput" class="todo-input" placeholder="할 일 입력...">
            <input type="date" id="deadlineInput" class="date-input">
            <button id="addTodoBtn" class="add-btn">추가</button>
          </div>
        </div>
        <h2 style="color:#00b49a;margin:20px 0 10px 0;font-size:1em;font-weight:800;">나의 할일</h2>
        <div id="todoListContainer"></div>
        <h2 style="color:#00b49a;margin:25px 0 10px 0;font-size:1em;font-weight:800;">메일 분석 할일</h2>
        <div id="emailTodoListContainer"></div>`;

      document.getElementById('addTodoBtn').onclick = async () => {
        const input = document.getElementById('todoInput');
        const date = document.getElementById('deadlineInput');
        if (!input.value.trim()) return;
        await window.electronAPI.insertTodo({ task: input.value, deadline: date.value || null });
        input.value = ''; date.value = '';
        refreshAll();
      };
      refreshAll();
    }

    // 2. 키워드 관리 (2컬럼 분리형)
    async function renderKeywordPage() {
      widgetMain.innerHTML = `
        <h2 style="color:#00b49a;margin:0 0 15px 0;font-size:1.1em;font-weight:800;">키워드 지능형 관리</h2>
        <div class="input-section">
          <div class="input-row">
            <input type="text" id="keywordInput" class="todo-input" placeholder="키워드 입력...">
            <select id="keywordType" class="date-input" style="width: 80px; height: 38px;">
              <option value="include">추출</option>
              <option value="exclude">제외</option>
            </select>
            <button id="addKeywordBtn" class="add-btn">등록</button>
          </div>
        </div>
        <div style="display: flex; gap: 15px; margin-top: 15px;">
          <div style="flex: 1;">
            <h3 style="font-size: 0.85em; color: #00b49a; margin-bottom: 10px; border-bottom: 2px solid #e6fffb;">추출 (Include)</h3>
            <div id="includeListContainer" style="display: flex; flex-direction: column; gap: 6px;"></div>
          </div>
          <div style="flex: 1;">
            <h3 style="font-size: 0.85em; color: #ff5e5e; margin-bottom: 10px; border-bottom: 2px solid #fff5f5;">제외 (Exclude)</h3>
            <div id="excludeListContainer" style="display: flex; flex-direction: column; gap: 6px;"></div>
          </div>
        </div>`;

      const input = document.getElementById('keywordInput');
      const typeSelect = document.getElementById('keywordType');
      const incBox = document.getElementById('includeListContainer');
      const excBox = document.getElementById('excludeListContainer');

      const refresh = async () => {
        const ks = await window.electronAPI.getKeywords();
        const draw = (k) => `
          <div class="kw-badge" style="background:${k.type === 'exclude' ? '#fff5f5' : '#e6fffb'}; border:1px solid ${k.type === 'exclude' ? '#ffcfcf' : '#7be2c5'}; color:${k.type === 'exclude' ? '#ff5e5e' : '#00b49a'}; justify-content:space-between;">
            <span>${k.word}</span>
            <span class="del-kw" data-id="${k.id}" style="cursor:pointer;font-weight:800;">&times;</span>
          </div>`;

        incBox.innerHTML = ks.filter(k => k.type !== 'exclude').map(draw).join('');
        excBox.innerHTML = ks.filter(k => k.type === 'exclude').map(draw).join('');

        document.querySelectorAll('.del-kw').forEach(s => s.onclick = async () => {
          await window.electronAPI.deleteKeyword(Number(s.dataset.id));
          refresh();
        });
      };

      document.getElementById('addKeywordBtn').onclick = async () => {
        if (!input.value.trim()) return;
        await window.electronAPI.insertKeyword(input.value.trim(), typeSelect.value);
        input.value = ''; refresh();
      };
      refresh();
    }

    // 3. 휴지통
    async function renderTrashPage() {
      widgetMain.innerHTML = `<h2 style="color:#00b49a;margin-bottom:15px;font-size:1em;">휴지통</h2><div id="trash-list"></div>`;
      const todos = await window.electronAPI.getTodos('trash');
      const list = document.getElementById('trash-list');
      list.innerHTML = todos.length ? todos.map(t => `
        <div class="todo-card" style="opacity:0.6; display:flex; justify-content:space-between; align-items:center;">
          <span>${t.task}</span>
          <button class="action-btn restore-btn" data-id="${t.id}" style="border-color:#00b49a; color:#00b49a;">복구</button>
        </div>`).join('') : '<p style="text-align:center;color:#aaa;padding:20px;">휴지통이 비었습니다.</p>';
      
      list.querySelectorAll('.restore-btn').forEach(b => b.onclick = async () => {
        await window.electronAPI.setTodoComplete(Number(b.dataset.id), 1);
        renderTrashPage();
      });
    }

    // 사이드바 이벤트
    document.querySelectorAll('.sidebar-btn').forEach(btn => btn.onclick = () => {
      const type = btn.getAttribute('data-type');
      if (type === 'main') renderMainPage();
      else if (type === 'keyword') renderKeywordPage();
      else if (type === 'trash') renderTrashPage();
    });

    document.getElementById('closeBtn').onclick = () => window.electronAPI.close();

    // 초기 실행
    renderMainPage();

    // 실시간 수신
    if (window.electronAPI.onNewTodoAdded) {
      window.electronAPI.onNewTodoAdded(() => refreshAll());
    }
  </script>
</body>
</html>