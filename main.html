<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Pomeranian</title>
  <style>
    html, body {
      width: 33.33vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
      overflow: hidden;
    }
    #widgetHomeMain {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
    .widget-home {
      width: 100%;
      height: 100%;
      min-width: 320px;
      max-width: 100vw;
      min-height: 400px;
      max-height: 100vh;
      position: absolute;
      top: 0; left: 0;
      background: #f8fffd;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: none;
    }
    .widget-home-header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: center; position: relative; padding: 0 24px; box-shadow: 0 2px 8px #00b49a11; font-size: 1.15em; font-weight: bold; color: #00b49a; -webkit-app-region: drag; flex-shrink: 0; }
    .sidebar-toggle-btn { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: transparent; border: none; font-size: 1.7em; color: #00b49a; cursor: pointer; z-index: 10; }
    .widget-home.hide-sidebar .widget-home-sidebar { display: none !important; }
    .widget-home.hide-sidebar .widget-content-area { padding-left: 0 !important; }
    .widget-home-header * { -webkit-app-region: no-drag; }
    .widget-home-sidebar { width: 56px; height: 100%; background: #ffffff; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; gap: 16px; padding-top: 20px; flex-shrink: 0; }
    .sidebar-btn { background: transparent; border: none; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #00b49a; transition: 0.2s; }
    .sidebar-btn:hover { background: #e6fffb; }
    .sidebar-btn svg { width: 22px; height: 22px; stroke: currentColor; }
    .widget-content-area {
      display: flex;
      flex: 1;
      overflow: hidden;
      width: 100%;
      height: calc(100% - 64px);
    }
    .widget-home-main {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      background: #f8fffd;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
    
    /* 할일 카드 스타일 */
    .todo-card { position: relative; background: #fff; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0, 180, 154, 0.08); border-left: 5px solid #00b49a; transition: 0.2s; cursor: pointer; }
    .todo-card.purple { background: #f5edff !important; border-left-color: #a259e4 !important; }
    .todo-card.orange { background: #fff4e6 !important; border-left-color: #ff9800 !important; }
    .todo-card.blue { background: #e6f2ff !important; border-left-color: #2196f3 !important; }
    .todo-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 180, 154, 0.12); }
    .todo-card.completed { border-left-color: #bbb !important; background: #f2f2f2 !important; opacity: 0.7; }
    .todo-card.completed .todo-content { text-decoration: line-through; color: #888; }
    .shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }

    .todo-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .todo-content-wrapper { flex: 1; }
    .todo-content { font-weight: 600; color: #333; font-size: 1em; line-height: 1.4; display: block; }
    .todo-source { font-size: 0.75em; color: #00b49a; font-weight: bold; margin-bottom: 4px; display: block; }
    
    .todo-actions { display: flex; align-items: center; gap: 6px; }
    .action-btn { background: #fff; border: 1.2px solid #bbb; color: #888; border-radius: 6px; padding: 2px 7px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .action-btn:hover { background: #eee; color: #333; }
    .delete-icon-btn { background: transparent; border: none; cursor: pointer; padding: 0; align-items: center; }

    .todo-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .todo-date { font-size: 0.8em; color: #777; background: #f0fcf9; padding: 2px 8px; border-radius: 4px; }
    
    .d-day-badge { font-size: 0.75em; font-weight: bold; padding: 2px 8px; border-radius: 6px; color: #fff; }
    .d-day-active { background: #00b49a; }
    .d-day-urgent { background: #ff5e5e; }
    .d-day-passed { background: #ddd; color: #777; }

    /* 입력 섹션 */
    .input-section { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eef2f1; }
    .input-row { display: flex; gap: 6px; }
    .todo-input { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1.5px solid #7be2c5; outline: none; }
    .date-input { width: 120px; border-radius: 8px; border: 1.5px solid #7be2c5; padding: 0 5px; }
    .add-btn { background: #00b49a; color: #fff; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* 키워드 뱃지 */
    .kw-badge { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
  </style>
</head>
<body>
  <div class="widget-home">
    <script>
    // 알림 설정 주기대로 할일 카드 흔들림 제어
    // 흔들릴 때마다 색상 변경 (보라, 오렌지, 파랑 순환)
    let shakeColorIndex = 0;
    const shakeColors = ['purple', 'orange', 'blue'];
    function shakeTodoCardsByAlarm() {
      const alarmInterval = Number(localStorage.getItem('todoAlarmInterval')) || 0;
      const alarmDay = Number(localStorage.getItem('todoAlarmDay')) || 0;
      if (!alarmInterval || !alarmDay) return;
      const today = new Date();
      document.querySelectorAll('.todo-card').forEach(card => {
        const dateSpan = card.querySelector('.todo-date');
        if (!dateSpan) return;
        const deadlineStr = dateSpan.getAttribute('data-deadline');
        if (!deadlineStr) return;
        const deadline = new Date(deadlineStr);
        const diff = Math.floor((deadline - today) / (1000*60*60*24));
        if (diff <= alarmDay && diff >= 0) {
          // 색상 순환 적용
          shakeColors.forEach(color => card.classList.remove(color));
          const colorClass = shakeColors[shakeColorIndex % shakeColors.length];
          card.classList.add(colorClass);
          card.classList.add('shake');
          setTimeout(() => {
            card.classList.remove('shake');
          }, 1000);
        } else {
          // 알림 범위가 아니면 색상 원래대로
          shakeColors.forEach(color => card.classList.remove(color));
        }
      });
      shakeColorIndex++;
    }
    // 기존 타이머 제거
    if (window.todoCardShakeTimerId) {
      clearInterval(window.todoCardShakeTimerId);
      window.todoCardShakeTimerId = null;
    }
    // 알림 설정값 있을 때만 타이머 실행
    function startTodoCardShakeTimer() {
      if (window.todoCardShakeTimerId) {
        clearInterval(window.todoCardShakeTimerId);
        window.todoCardShakeTimerId = null;
      }
      const alarmInterval = Number(localStorage.getItem('todoAlarmInterval')) || 0;
      if (!alarmInterval) return;
      window.todoCardShakeTimerId = setInterval(shakeTodoCardsByAlarm, alarmInterval * 60 * 1000);
    }
    // 최초 실행 및 알림 설정 변경 시 타이머 재시작
    document.addEventListener('DOMContentLoaded', () => {
      startTodoCardShakeTimer();
    });
    window.startTodoCardShakeTimer = startTodoCardShakeTimer;
    // 알림 설정 저장/변경 시 타이머 재시작 (기존 저장 이벤트에 추가 필요)
    </script>
    <div class="widget-home-header">
      <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="사이드바 토글" aria-label="사이드바 토글">
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="5" width="18" height="16" rx="2" fill="#00b49a" fill-opacity="0.13" stroke="#00b49a" stroke-width="1.5"/>
          <line x1="13" y1="6.5" x2="13" y2="19.5" stroke="#00b49a" stroke-width="1.5"/>
        </svg>
      </button>
      <div style="display:flex;align-items:center;justify-content:center;gap:10px;width:100%;">
        <img src="assets/icon.png" alt="앱 아이콘" style="width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;">
        <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
      </div>
      <button id="closeBtn" style="position:absolute;right:24px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">&times;</button>
    </div>

    <div class="widget-content-area">
      <div class="widget-home-sidebar">
        <button class="sidebar-btn" title="홈" data-type="main">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </button>
        <button class="sidebar-btn" title="키워드" data-type="keyword">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3-3.5 3.5z"/></svg>
        </button>
        <button class="sidebar-btn" title="휴지통" data-type="trash">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        </button>
        <button class="sidebar-btn" title="알림" data-type="notification">
          <span id="notification-bell-wrapper" style="display:inline-block;position:relative;">
            <svg id="notification-bell-icon" viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 16v-5a6 6 0 1 0-12 0v5a2 2 0 0 1-2 2h16a2 2 0 0 1-2-2z"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
              <line id="notification-bell-off-line" x1="5" y1="19" x2="19" y2="5" stroke="#ff335e" stroke-width="2.2" style="display:none;" />
            </svg>
          </span>
        </button>
        <button class="sidebar-btn" title="환경설정" data-type="settings">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3.2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09A1.65 1.65 0 0 0 16 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 8c.14.31.22.65.22 1v.09A1.65 1.65 0 0 0 21 12c0 .35-.08.69-.22 1z"/></svg>
        </button>
        <div style="flex:1;"></div>
      </div>

      <div class="widget-home-main" id="widgetHomeMain"></div>
    </div>
  </div>

  <script>
    // 사이드바 토글 기능
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      const widgetHome = document.querySelector('.widget-home');
      sidebarToggleBtn.onclick = function(e) {
        e.stopPropagation();
        widgetHome.classList.toggle('hide-sidebar');
      };
    });

    // 알림 페이지 렌더 함수
    function renderNotificationPage() {
            // 알림 상태에 따라 벨 아이콘 스타일 변경
            function updateBellIcon() {
              const bellLine = document.getElementById('notification-bell-off-line');
              if (!bellLine) return;
              const hasAlarm = localStorage.getItem('todoAlarmInterval') && localStorage.getItem('todoAlarmDay');
              bellLine.style.display = hasAlarm ? 'none' : 'block';
            }
            updateBellIcon();
      const widgetMain = document.getElementById('widgetHomeMain');
      if (!widgetMain) return;
      widgetMain.innerHTML = `
        <div style="max-width:420px;margin:0 auto;padding:0 8px;">
          <div style="font-size:1.18em;font-weight:bold;color:#00b49a;margin-bottom:22px;text-align:left;display:flex;align-items:center;gap:8px;">
            <svg viewBox='0 0 24 24' width='24' height='24' fill='none' stroke='#00b49a' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;'><path d='M18 16v-5a6 6 0 1 0-12 0v5a2 2 0 0 1-2 2h16a2 2 0 0 1-2-2z'/><path d='M13.73 21a2 2 0 0 1-3.46 0'/></svg>
            알림
          </div>
          <form id="notification-settings-form" style="background:#f8fffd;border:1px solid #e0f7f3;border-radius:10px;padding:16px 14px 10px 14px;margin-bottom:18px;">
            <div style="font-weight:bold;color:#0093b4;margin-bottom:10px;">할일 알림 설정</div>
            <div style="margin-bottom:10px;">
              <label style="font-size:0.98em;color:#333;">알림 간격(분): </label>
              <input id="alarm-interval" type="number" min="1" max="1440" step="1" value="10" style="padding:4px 10px;border-radius:6px;border:1px solid #7be2c5;width:70px;" />
              <span style="color:#888;font-size:0.92em;">(1~1440분, 직접 입력)</span>
            </div>
            <div style="margin-bottom:10px;">
              <label style="font-size:0.98em;color:#333;">마감일 며칠 전부터 알림: </label>
              <input id="alarm-day-input" type="number" min="1" max="365" step="1" placeholder="예: 2" style="padding:4px 10px;border-radius:6px;border:1px solid #7be2c5;min-width:60px;width:80px;" />
              <span style="color:#888;font-size:0.92em;">(d- 뒤 숫자만 입력, 예: 2)</span>
            </div>
            <button type="submit" style="background:#00b49a;color:#fff;border:none;padding:7px 22px;border-radius:7px;font-size:1em;font-weight:bold;cursor:pointer;">저장</button>
            <button type="button" id="alarm-off-btn" style="background:#e0e0e0;color:#888;border:none;padding:7px 18px;border-radius:7px;font-size:1em;font-weight:bold;cursor:pointer;margin-left:8px;">알림끄기</button>
            <span id="alarm-save-msg" style="margin-left:10px;color:#00b49a;font-size:0.97em;display:none;">저장됨!</span>
          </form>
          <div style="color:#0093b4;font-size:1em;margin-bottom:12px;">최근 알림이 여기에 표시됩니다.</div>
          <ul id="notification-list" style="padding:0;list-style:none;color:#333;font-size:0.98em;"></ul>
        </div>
      `;
      // 예시 알림 데이터
      const notifications = [
        { msg: '오늘 할일 2건이 마감입니다.', date: '2025-12-24 09:00' },
        { msg: '새로운 메일이 도착했습니다.', date: '2025-12-23 18:12' }
      ];
      const list = document.getElementById('notification-list');
      if (list) {
        list.innerHTML = notifications.length ? notifications.map(n => `<li style='margin-bottom:10px;'><span style='color:#00b49a;font-weight:bold;'>[알림]</span> ${n.msg}<br><span style='color:#aaa;font-size:0.92em;'>${n.date}</span></li>`).join('') : '<li>알림이 없습니다.</li>';
      }
      // 저장 이벤트
      const form = document.getElementById('notification-settings-form');
      form.onsubmit = function(e) {
        e.preventDefault();
        const interval = document.getElementById('alarm-interval').value;
        if (!interval || isNaN(interval) || interval < 1 || interval > 1440) {
          alert('알림 간격은 1~1440분 사이의 숫자로 입력하세요.');
          return;
        }
        let dayValue = document.getElementById('alarm-day-input').value.trim();
        if (!dayValue || isNaN(dayValue) || dayValue < 1 || dayValue > 365) {
          alert('마감일 알림은 1~365 사이의 숫자만 입력하세요.');
          return;
        }
        localStorage.setItem('todoAlarmInterval', interval);
        localStorage.setItem('todoAlarmDay', dayValue);
        const msg = document.getElementById('alarm-save-msg');
        if (msg) {
          msg.style.display = 'inline';
          setTimeout(() => { msg.style.display = 'none'; }, 1200);
        }
        // 벨 아이콘 갱신
        if (typeof updateBellIcon === 'function') updateBellIcon();
        // 알림 타이머 즉시 재시작
        if (window.startTodoAlarmTimer) window.startTodoAlarmTimer();
        // 벨 아이콘 갱신
        if (typeof updateBellIcon === 'function') updateBellIcon();
      };
      // 알림끄기 버튼 이벤트
      const alarmOffBtn = document.getElementById('alarm-off-btn');
      if (alarmOffBtn) {
        alarmOffBtn.onclick = function() {
          localStorage.removeItem('todoAlarmInterval');
          localStorage.removeItem('todoAlarmDay');
          if (window.todoAlarmTimerId) {
            clearInterval(window.todoAlarmTimerId);
            window.todoAlarmTimerId = null;
          }
          // 커스텀 팝업
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.left = 0;
          modal.style.top = 0;
          modal.style.width = '100vw';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.18)';
          modal.style.display = 'flex';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          modal.style.zIndex = 9999;
          modal.innerHTML = `
            <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
                <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
              </div>
              <div style="margin:12px 0 0 0;font-size:1.05em;color:#222;text-align:center;">알림이 해제되었습니다.</div>
              <div style="display:flex;gap:18px;margin-top:18px;">
                <button id="closeAlarmOffPopup" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">확인</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          document.getElementById('closeAlarmOffPopup').onclick = () => modal.remove();
          // 벨 아이콘 갱신
          if (typeof updateBellIcon === 'function') updateBellIcon();
          // 알림 타이머 즉시 중지
          if (window.startTodoAlarmTimer) window.startTodoAlarmTimer();
          // 벨 아이콘 갱신
          if (typeof updateBellIcon === 'function') updateBellIcon();
        };
      }
      // 기존 설정 불러오기
      const savedInterval = localStorage.getItem('todoAlarmInterval');
      const savedDay = localStorage.getItem('todoAlarmDay');
      if (savedInterval) document.getElementById('alarm-interval').value = savedInterval;
      if (savedDay) document.getElementById('alarm-day-input').value = savedDay;
    }

    // ===== 무료 사용기간 만료 체크 (2026-01-03 이후 차단) =====
    (function() {
      const today = new Date();
      const expireDate = new Date('2026-01-03T00:00:00+09:00');
      if (today >= expireDate) {
        // 만료 안내 커스텀 팝업
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.left = 0;
        modal.style.top = 0;
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.18)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = 99999;
        modal.innerHTML = `
          <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
              <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
            </div>
            <div style="margin:12px 0 0 0;font-size:1.05em;color:#222;text-align:center;">무료 사용기간이 만료되었습니다.<br>서비스 이용을 원하시면 관리자에게 문의해 주세요.<br><br><span style='color:#ff335e;font-size:0.95em;'>만료일: 2026-01-03</span></div>
            <div style="display:flex;gap:18px;margin-top:18px;">
              <button id="closeExpirePopup" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">확인</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('closeExpirePopup').onclick = () => {
          window.close();
        };
        // 주요 UI 비활성화
        document.body.style.pointerEvents = 'none';
        modal.style.pointerEvents = 'auto';
      }
    })();
    const widgetMain = document.getElementById('widgetHomeMain');

    // [유틸] D-Day 계산
    function getDDay(deadline) {
      if (!deadline || deadline === '없음') return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const target = new Date(deadline); target.setHours(0,0,0,0);
      if (isNaN(target)) return null;
      const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return { text: "오늘까지", class: "d-day-urgent" };
      if (diffDays > 0) return { text: `D-${diffDays}`, class: diffDays <= 3 ? "d-day-urgent" : "d-day-active" };
      return { text: `지남`, class: "d-day-passed" };
    }

    // [유틸] 카드 HTML 생성
    function createCardHtml(item, isEmail = false) {
      const dday = getDDay(item.deadline);
      // 긴급성 점수 계산 (이메일만)
      let urgencyRating = null;
      if (isEmail && item.deadline && item.deadline !== '없음') {
        const today = new Date(); today.setHours(0,0,0,0);
        const target = new Date(item.deadline); target.setHours(0,0,0,0);
        if (!isNaN(target)) {
          const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
          if (diffDays <= 1) urgencyRating = 5;
          else if (diffDays <= 3) urgencyRating = 4;
          else if (diffDays <= 7) urgencyRating = 3;
          else if (diffDays <= 10) urgencyRating = 2;
          else if (diffDays <= 14) urgencyRating = 1;
          else urgencyRating = 0;
        }
      }
      const isDone = Number(item.todo_flag) === 2;
      const taskId = item.id;
      const title = isEmail ? (item.subject || '(제목 없음)') : (item.task || item.content);
      
      return `
        <div class="todo-card ${isDone ? 'completed' : ''}" data-id="${taskId}" data-is-email="${isEmail}" draggable="true"${urgencyRating !== null ? ` data-urgency-rating="${urgencyRating}"` : ''}>
          <div class="todo-top">
            <div class="todo-content-wrapper">
              ${isEmail ? `<span class="todo-source">Email: ${item.from_addr || '알 수 없음'}</span>` : ''}
                <span class="todo-content">${isEmail && urgencyRating !== null && urgencyRating >= 4 ? '★ ' : ''}${title}</span>
            </div>
            <div class="todo-actions" style="flex-direction:column;align-items:flex-end;gap:4px;">
              ${!isDone ? `<button class="action-btn exclude-btn">제외</button>` : ''}
              ${isEmail ? `<span class="view-body-link" style="color:#888;cursor:pointer;text-decoration:underline;font-size:0.92em;margin-top:2px;">본문보기</span>` : ''}
              <button class="delete-icon-btn" style="${isDone ? 'display:flex;' : 'display:none;'}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="todo-bottom">
            <div class="todo-info-group">
              <span class="todo-date" data-deadline="${item.deadline || ''}" data-id="${taskId}">
                ${item.deadline && item.deadline !== '없음' ? '마감: ' + item.deadline : '마감 없음'}
              </span>
              ${dday && !isDone ? `<span class="d-day-badge ${dday.class}">${dday.text}</span>` : ''}
            </div>
          </div>
        </div>`;
    }

    // 카드 이벤트 바인딩 및 드래그앤드롭
    function bindCardEvents(container) {
      let dragSrc = null;
      container.querySelectorAll('.todo-card').forEach(card => {
                        // 이메일 본문보기 링크 클릭 이벤트
                        const viewBodyLink = card.querySelector('.view-body-link');
                        if (viewBodyLink && card.getAttribute('data-is-email') === 'true') {
                          viewBodyLink.onclick = (e) => {
                            e.stopPropagation();
                            // 이메일 본문 데이터 추출
                            const cardData = card.__itemData || null;
                            let body = '';
                            if (cardData && cardData.body) {
                              // MIME 경계 문자열만 있는 경우 빈 공란 처리
                              const trimmed = cardData.body.trim();
                              // MIME 경계 문자열+Content-Type 헤더만 있는 경우도 빈 공란 처리
                              if (/^--[\w-]{10,}(\r?\n)?Content-Type:.*(--[\w-]{10,}--)?$/is.test(trimmed.replace(/\r/g, '')) ||
                                  (/^--[\w-]{10,}/.test(trimmed) && trimmed.replace(/[-\w]/g, '').replace(/\s/g, '') === '')) {
                                body = '';
                              } else {
                                body = cardData.body;
                              }
                            } else {
                              // fallback: 카드 내부에 숨겨진 데이터가 없으면 안내
                              body = '이메일 본문 데이터를 불러올 수 없습니다.';
                            }
                            // 모달 생성
                            const modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.left = 0;
                            modal.style.top = 0;
                            modal.style.width = '100vw';
                            modal.style.height = '100vh';
                            modal.style.background = 'rgba(0,0,0,0.18)';
                            modal.style.display = 'flex';
                            modal.style.alignItems = 'center';
                            modal.style.justifyContent = 'center';
                            modal.style.zIndex = 99999;
                            modal.innerHTML = `
                              <div style="background:#fff;padding:32px 36px 24px 36px;border-radius:14px;min-width:320px;max-width:90vw;max-height:80vh;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;overflow:auto;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                  <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
                                  <span style="font-weight:800;font-size:1.15em;">이메일 본문</span>
                                </div>
                                <div style="margin:12px 0 0 0;font-size:1em;color:#222;text-align:left;max-width:60vw;max-height:45vh;overflow:auto;white-space:pre-wrap;word-break:break-all;">${body ? body.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '(내용 없음)'}</div>
                                <div style="display:flex;gap:18px;margin-top:18px;">
                                  <button id="closeBodyModalBtn" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">닫기</button>
                                </div>
                              </div>
                            `;
                            document.body.appendChild(modal);
                            document.getElementById('closeBodyModalBtn').onclick = () => modal.remove();
                          };
                        }
                // 마감일 클릭시 date input으로 변경
                const dateSpan = card.querySelector('.todo-date');
                if (dateSpan) {
                  dateSpan.onclick = function(e) {
                    e.stopPropagation();
                    if (card.classList.contains('completed')) return; // 완료된 할일은 편집 불가
                    // 이미 input이 있으면 무시
                    if (dateSpan.querySelector('input')) return;
                    const oldDeadline = dateSpan.getAttribute('data-deadline');
                    const id = dateSpan.getAttribute('data-id');
                    // input 생성
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.className = 'date-input';
                    input.style.marginLeft = '6px';
                    input.value = oldDeadline && oldDeadline !== '없음' ? oldDeadline : '';
                    dateSpan.innerHTML = '마감:';
                    dateSpan.appendChild(input);
                    input.focus();
                    input.onblur = async function() {
                      const newVal = input.value;
                      if (newVal && newVal !== oldDeadline) {
                        if (card.getAttribute('data-is-email') === 'true') {
                          await window.electronAPI.setEmailDeadline(id, newVal);
                        } else {
                          await window.electronAPI.setTodoDeadline(Number(id), newVal);
                        }
                        refreshAll();
                      } else {
                        dateSpan.innerHTML = oldDeadline && oldDeadline !== '없음' ? '마감: ' + oldDeadline : '마감 없음';
                      }
                    };
                    input.onkeydown = async function(ev) {
                      if (ev.key === 'Enter') {
                        input.blur();
                      } else if (ev.key === 'Escape') {
                        dateSpan.innerHTML = oldDeadline && oldDeadline !== '없음' ? '마감: ' + oldDeadline : '마감 없음';
                      }
                    };
                  };
                }
        const id = Number(card.getAttribute('data-id'));
        const isEmail = card.getAttribute('data-is-email') === 'true';

        // 완료 토글
        card.querySelector('.todo-content').onclick = async () => {
          const isDone = card.classList.contains('completed');
          const nextFlag = isDone ? 1 : 2;
          if (isEmail) await window.electronAPI.setMailComplete(id, nextFlag);
          else await window.electronAPI.setTodoComplete(id, nextFlag);
          refreshAll();
        };

        // 휴지통으로 이동
        const delBtn = card.querySelector('.delete-icon-btn');
        if (delBtn) {
          delBtn.onclick = async (e) => {
            e.stopPropagation();
            if (isEmail) await window.electronAPI.setMailComplete(id, 3);
            else await window.electronAPI.setTodoComplete(id, 3);
            refreshAll();
          };
        }

        // 키워드 제외
        const exBtn = card.querySelector('.exclude-btn');
        if (exBtn) {
          exBtn.onclick = async (e) => {
            e.stopPropagation();
            // 커스텀 확인창 생성
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = 0;
            modal.style.top = 0;
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.18)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = 9999;
            modal.innerHTML = `
              <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;">
                <div style="display:flex;align-items:center;gap:10px;">
                  <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
                  <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
                </div>
                <div style="margin:12px 0 0 0;font-size:1.05em;color:#222;text-align:center;">이 항목을 제외하고 동일한 메일을 차단할까요?</div>
                <div style="display:flex;gap:18px;margin-top:18px;">
                  <button id="confirmExcludeBtn" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">확인</button>
                  <button id="cancelExcludeBtn" style="background:#eee;color:#333;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">취소</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('confirmExcludeBtn').onclick = async () => {
              await window.electronAPI.excludeTodo(id, isEmail);
              modal.remove();
              refreshAll();
            };
            document.getElementById('cancelExcludeBtn').onclick = () => modal.remove();
          };
        }

        // --- 드래그앤드롭 이벤트 ---
        card.addEventListener('dragstart', function(e) {
          dragSrc = card;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        card.addEventListener('dragend', function() {
          card.classList.remove('dragging');
          dragSrc = null;
        });
        card.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });
        card.addEventListener('dragenter', function(e) {
          e.preventDefault();
          if (card !== dragSrc) card.classList.add('drag-over');
        });
        card.addEventListener('dragleave', function() {
          card.classList.remove('drag-over');
        });
        card.addEventListener('drop', function(e) {
          e.preventDefault();
          if (card !== dragSrc) {
            card.classList.remove('drag-over');
            // DOM에서 위치 바꾸기
            if (dragSrc && dragSrc.parentNode === card.parentNode) {
              card.parentNode.insertBefore(dragSrc, card.nextSibling);
            }
            // 순서 저장
            saveTodoOrder(container);
          }
        });
      });
    }

    // 순서 저장 함수
    async function saveTodoOrder(container) {
      const cards = Array.from(container.querySelectorAll('.todo-card'));
      const orderArray = cards.map((card, idx) => ({
        id: Number(card.getAttribute('data-id')),
        order: idx
      }));
      if (orderArray.length > 0) {
        await window.electronAPI.updateTodoOrder(orderArray);
        refreshAll();
      }
    }

// 메인 리스트 새로고침
async function refreshAll() {
  const userContainer = document.getElementById('todoListContainer');
  const emailContainer = document.getElementById('emailTodoListContainer');
  if (!userContainer || !emailContainer) return;

  const userTodos = await window.electronAPI.getTodos();
  const userCount = (userTodos && userTodos.length) ? userTodos.length : 0;
  const userCountSpan = document.getElementById('userTodoCount');
  if (userCountSpan) userCountSpan.textContent = userCount;
  userContainer.innerHTML = userCount
    ? userTodos.map(t => createCardHtml(t, false)).join('')
    : '<p style="text-align:center;color:#bbb;padding:10px;">등록된 할일이 없습니다.</p>';

  let emailTodos = await window.electronAPI.getTodoEmails();
  const emailCount = (emailTodos && emailTodos.length) ? emailTodos.length : 0;
  // 긴급성 점수 계산 및 정렬
  if (emailCount) {
    emailTodos = emailTodos.map(e => {
      let urgencyRating = 0;
      if (e.deadline && e.deadline !== '없음') {
        const today = new Date(); today.setHours(0,0,0,0);
        const target = new Date(e.deadline); target.setHours(0,0,0,0);
        if (!isNaN(target)) {
          const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
          if (diffDays <= 1) urgencyRating = 5;
          else if (diffDays <= 3) urgencyRating = 4;
          else if (diffDays <= 7) urgencyRating = 3;
          else if (diffDays <= 10) urgencyRating = 2;
          else if (diffDays <= 14) urgencyRating = 1;
        }
      }
      return { ...e, urgencyRating };
    });
    emailTodos.sort((a, b) => b.urgencyRating - a.urgencyRating);
  }
  const emailCountSpan = document.getElementById('emailTodoCount');
  if (emailCountSpan) emailCountSpan.textContent = emailCount;
  emailContainer.innerHTML = emailCount
    ? emailTodos.map(e => createCardHtml(e, true)).join('')
    : '<p style="text-align:center;color:#bbb;padding:10px;">이메일 할일이 없습니다.</p>';

  // 이메일 카드에 본문 데이터 연결
  if (emailCount) {
    const cards = emailContainer.querySelectorAll('.todo-card');
    emailTodos.forEach((e, idx) => {
      if (cards[idx]) cards[idx].__itemData = e;
    });
  }
  bindCardEvents(userContainer);
  bindCardEvents(emailContainer);
}

    // 1. 메인 페이지
    async function renderMainPage() {
      widgetMain.innerHTML = `
        <h2 style="color:#00b49a;margin:0 0 12px 0;font-size:1em;font-weight:800;">새 할일</h2>
      

        <div class="input-section">
          <div class="input-row">
            <input type="text" id="todoInput" class="todo-input" placeholder="할 일 입력...">
            <input type="date" id="deadlineInput" class="date-input">
            <button id="addTodoBtn" class="add-btn">추가</button>
          </div>
        </div>
        <h2 style="color:#00b49a;margin:20px 0 10px 0;font-size:1em;font-weight:800;">
  나의 할일 <span id="userTodoCount" style="font-size:0.85em;background:#e6fffb;color:#00b49a;padding:2px 8px;border-radius:10px;font-weight:800;">0</span>
</h2>
        <div id="todoListContainer"></div>
        <h2 style="color:#00b49a;margin:25px 0 10px 0;font-size:1em;font-weight:800;">
  메일 분석 할일 <span id="emailTodoCount" style="font-size:0.85em;background:#fff5f5;color:#ff335e;padding:2px 8px;border-radius:10px;font-weight:800;">0</span>
</h2>
        <div id="emailTodoListContainer"></div>`;

      document.getElementById('addTodoBtn').onclick = async () => {
        const input = document.getElementById('todoInput');
        const date = document.getElementById('deadlineInput');
        if (!input.value.trim()) return;
        await window.electronAPI.insertTodo({ task: input.value, deadline: date.value || null });
        input.value = ''; date.value = '';
        refreshAll();
      };
      refreshAll();
    }

    
// 2. 키워드 관리 (추출/제외 2컬럼 완벽 분리형 - 최종본)
async function renderKeywordPage() {
  widgetMain.innerHTML = `
    <h2 style="color:#00b49a; margin:0 0 15px 0; font-size:1.1em; font-weight:800;">키워드 지능형 관리</h2>
    <P style="color:#00b49a; margin:0 0 12px 0; font-size:0.8em; font-weight:300;">키워드가 있는 이메일을 할일로 분류합니다.</p>
    
    <div class="input-section">
      <div class="input-row" style="display: flex; gap: 8px; align-items: center;">
        <input type="text" id="keywordInput" class="todo-input" placeholder="키워드 입력..." style="flex: 1;">
        <select id="keywordType" class="todo-input" style="width: 85px; height: 42px; flex: none; background: #fff; cursor: pointer; font-weight: 600; color: #555;">
          <option value="include">추출</option>
          <option value="exclude">제외</option>
        </select>
        <button id="addKeywordBtn" class="add-btn" style="height: 42px; width: 60px; flex: none;">등록</button>
      </div>
    </div>

    <div style="display: flex; gap: 20px; margin-top: 10px; height: calc(100% - 150px); overflow: hidden;">
      <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e6fffb;">
          <span style="font-size: 0.85em; font-weight: 800; color: #00b49a;">추출 (Include)</span>
          <span id="incCount" style="font-size: 0.75em; background: #e6fffb; color: #00b49a; padding: 2px 8px; border-radius: 10px; font-weight: 800;">0</span>
        </div>
        <div id="includeListContainer" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px;"></div>
      </div>

      <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #fff5f5;">
          <span style="font-size: 0.85em; font-weight: 800; color: #ff5e5e;">제외 (Exclude)</span>
          <span id="excCount" style="font-size: 0.75em; background: #fff5f5; color: #ff5e5e; padding: 2px 8px; border-radius: 10px; font-weight: 800;">0</span>
        </div>
        <div id="excludeListContainer" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px;"></div>
      </div>
    </div>`;

  const input = document.getElementById('keywordInput');
  const typeSelect = document.getElementById('keywordType');
  const incBox = document.getElementById('includeListContainer');
  const excBox = document.getElementById('excludeListContainer');
  const incCount = document.getElementById('incCount');
  const excCount = document.getElementById('excCount');

  const refresh = async () => {
    try {
      // 1. DB에서 키워드 데이터 호출
      const ks = await window.electronAPI.getKeywords();
      
      // 2. 뱃지 생성 헬퍼 함수 (긴 텍스트 대응)
      const createBadge = (k) => `
        <div class="keyword-tag" style="
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          padding: 10px 12px; 
          border-radius: 12px; 
          font-size: 0.88em;
          background: ${k.type === 'exclude' ? '#fff5f5' : '#f0fcf9'};
          border: 1px solid ${k.type === 'exclude' ? '#ffcfcf' : '#7be2c5'};
          color: ${k.type === 'exclude' ? '#e74c3c' : '#00b49a'};
          box-shadow: 0 2px 4px rgba(0,0,0,0.02);
          transition: transform 0.1s;
        " title="${k.word}">
          <span style="
            font-weight: 600; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            margin-right: 10px;
          ">${k.word}</span>
          <span class="del-kw" data-id="${k.id}" style="
            cursor: pointer; 
            font-size: 1.3em; 
            font-weight: bold; 
            line-height: 1; 
            opacity: 0.6;
          " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">&times;</span>
        </div>`;

      // 3. 타입별 필터링 (기존 NULL 데이터는 'include'로 분류)
      const includes = ks.filter(k => k.type !== 'exclude');
      const excludes = ks.filter(k => k.type === 'exclude');

      // 4. 리스트 렌더링
      incBox.innerHTML = includes.length 
        ? includes.map(createBadge).join('') 
        : '<p style="color:#bbb; font-size:0.8em; text-align:center; margin-top:20px;">추출 키워드가 없습니다.</p>';
      
      excBox.innerHTML = excludes.length 
        ? excludes.map(createBadge).join('') 
        : '<p style="color:#bbb; font-size:0.8em; text-align:center; margin-top:20px;">제외 키워드가 없습니다.</p>';
      
      // 5. 개수 카운트 업데이트
      incCount.textContent = includes.length;
      excCount.textContent = excludes.length;

      // 6. 삭제 이벤트 바인딩
      document.querySelectorAll('.del-kw').forEach(s => {
        s.onclick = async (e) => {
          e.stopPropagation();
          // 커스텀 확인 모달 생성
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.left = 0;
          modal.style.top = 0;
          modal.style.width = '100vw';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.18)';
          modal.style.display = 'flex';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          modal.style.zIndex = 9999;
          modal.innerHTML = `
            <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
                <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
              </div>
              <div style="margin:12px 0 0 0;font-size:1.05em;color:#222;text-align:center;">'${s.parentElement.title.substring(0, 10)}...' 키워드를 삭제하시겠습니까?</div>
              <div style="display:flex;gap:18px;margin-top:18px;">
                <button id="confirmDelKeywordBtn" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">확인</button>
                <button id="cancelDelKeywordBtn" style="background:#eee;color:#333;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">취소</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          document.getElementById('confirmDelKeywordBtn').onclick = async () => {
            await window.electronAPI.deleteKeyword(Number(s.dataset.id));
            modal.remove();
            refresh();
          };
          document.getElementById('cancelDelKeywordBtn').onclick = () => modal.remove();
        };
      });
    } catch (err) {
      console.error("Keyword Refresh Error:", err);
    }
  };

  // 등록 버튼 클릭 이벤트
  document.getElementById('addKeywordBtn').onclick = async () => {
    const word = input.value.trim();
    if (!word) return;
    
    const type = typeSelect.value;
    // main.js의 insert-keyword 핸들러가 (word, type) 두 개를 받도록 수정되어 있어야 합니다.
    await window.electronAPI.insertKeyword(word, type);
    
    input.value = '';
    refresh();
  };

  // 엔터키 지원
  input.onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('addKeywordBtn').click(); };

  refresh();
}
    // 3. 휴지통
    async function renderTrashPage() {
      widgetMain.innerHTML = `<h2 style="color:#00b49a;margin-bottom:15px;font-size:1em;">휴지통</h2>
<p style="color:#00b49a; margin:0 0 12px 0; font-size:0.8em; font-weight:300;">완료한 할일들</p>

<div id="trash-list">
      </div>
       `;
 
      const todos = await window.electronAPI.getTodos('trash');
      const list = document.getElementById('trash-list');
      list.innerHTML = todos.length ? todos.map(t => `
        <div class="todo-card" style="opacity:0.6; display:flex; justify-content:space-between; align-items:center;">
          <span>${t.task}</span>
          <button class="action-btn restore-btn" data-id="${t.id}" style="border-color:#00b49a; color:#00b49a;">복구</button>
        </div>`).join('') : '<p style="text-align:center;color:#aaa;padding:20px;">휴지통이 비었습니다.</p>';
      
      list.querySelectorAll('.restore-btn').forEach(b => b.onclick = async () => {
        await window.electronAPI.setTodoComplete(Number(b.dataset.id), 1);
        renderTrashPage();
      });
    }

    // 사이드바 이벤트
    document.querySelectorAll('.sidebar-btn').forEach(btn => btn.onclick = () => {
      const type = btn.getAttribute('data-type');
      if (type === 'main') renderMainPage();
      else if (type === 'keyword') renderKeywordPage();
      else if (type === 'trash') renderTrashPage();
      else if (type === 'settings') renderSettingsPage();
      else if (type === 'notification') {
        renderNotificationPage();
        // 벨 아이콘 갱신(알림 페이지 진입 시 항상 반영)
        const bellLine = document.getElementById('notification-bell-off-line');
        if (bellLine) {
          const hasAlarm = localStorage.getItem('todoAlarmInterval') && localStorage.getItem('todoAlarmDay');
          bellLine.style.display = hasAlarm ? 'none' : 'block';
        }
      }
    });

    document.getElementById('closeBtn').onclick = () => window.electronAPI.close();

    // 앱 시작 시 연동정보 있으면 자동 연동
    window.addEventListener('DOMContentLoaded', async () => {
      const settings = await window.electronAPI.getMailSettings();
      if (settings && (settings.mailId || settings.mail_id) && (settings.mailPw || settings.mail_pw) && settings.host && settings.protocol) {
        try {
          await window.electronAPI.mailConnect(settings);
        } catch (e) { /* 무시 */ }
      }
    });
    renderMainPage();

    // 환경설정(이메일 연동) 페이지 렌더 함수
    async function renderSettingsPage() {
      const widgetMain = document.getElementById('widgetHomeMain');
      if (!widgetMain) return;
      widgetMain.innerHTML = `
          <div style="max-width:420px;margin:0 auto;padding:0 8px;">
            <div style="font-size:1.18em;font-weight:bold;color:#00b49a;margin-bottom:22px;text-align:left;">이메일 연동설정</div>
            <form id="mailFormMain">
              <div class="form-row" style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;">메일 종류</label>
                <select id="mailTypeMain" class="short-input" style="width:100%;padding:7px 10px;border-radius:7px;border:1.2px solid #7be2c5;">
                  <option value="naver">Naver</option>
                  <option value="gmail">Gmail</option>
                  <option value="custom">사용자선택</option>
                </select>
              </div>
              <div class="form-row" style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;">연동 방식</label>
                <select id="protocolMain" class="short-input" style="width:100%;padding:7px 10px;border-radius:7px;border:1.2px solid #7be2c5;">
                  <option value="imap-ssl">IMAP(SSL, 993)</option>
                  <option value="imap">IMAP(일반, 143)</option>
                  <option value="pop3-ssl">POP3(SSL, 995)</option>
                  <option value="pop3">POP3(일반, 110)</option>
                </select>
              </div>
              <div class="form-row" style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;">호스트(Host)</label>
                <input type="text" id="hostMain" class="short-input" placeholder="예: imap.example.com" autocomplete="off" style="width:80%;min-width:160px;max-width:320px;padding:7px 10px;border-radius:7px;border:1.2px solid #7be2c5;" />
              </div>
              <div class="form-row" style="margin-bottom:14px;">
                <label style="display:block;margin-bottom:4px;">아이디</label>
                <input type="text" id="mailIdMain" required class="short-input" placeholder="예: mailid@example.com" style="width:80%;min-width:160px;max-width:320px;padding:7px 10px;border-radius:7px;border:1.2px solid #7be2c5;" />
              </div>
              <div class="form-row" style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:4px;">비밀번호</label>
                <input type="password" id="mailPwMain" required class="short-input" style="width:80%;min-width:160px;max-width:320px;padding:7px 10px;border-radius:7px;border:1.2px solid #7be2c5;" />
              </div>
              <div class="form-row" style="text-align:center;">
                <button type="submit" class="connect-btn" style="background:#00b49a;color:#fff;border:none;padding:10px 32px;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;">연동하기</button>
              </div>
            </form>
          </div>
      `;
        
      // 연동하기 버튼 이벤트(예시, 실제 연동 로직은 필요시 추가)
      const mailForm = document.getElementById('mailFormMain');
      mailForm.onsubmit = async (e) => {
        e.preventDefault();
        // 입력값 수집
        const mailType = document.getElementById('mailTypeMain').value;
        const protocol = document.getElementById('protocolMain').value;
        const mailId = document.getElementById('mailIdMain').value;
        const mailPw = document.getElementById('mailPwMain').value;
        const host = document.getElementById('hostMain').value;
        // mailSince는 옵션(없으면 undefined)
        const mailSinceInput = document.getElementById('mailSinceMain');
        const mailSince = mailSinceInput ? mailSinceInput.value : undefined;
        const info = { mailType, protocol, mailId, mailPw, mailSince, host };
        // 1. DB에 저장
        await window.electronAPI.saveMailSettings(info);
        // 2. 연동 시도
        try {
          const result = await window.electronAPI.mailConnect(info);
          if(result && result.success) {
            // 커스텀 팝업: Pomeranian 제목, 아이콘 적용
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = 0;
            modal.style.top = 0;
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.18)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = 9999;
            modal.innerHTML = `
              <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;box-shadow:0 4px 24px #00b49c22;display:flex;flex-direction:column;align-items:center;gap:18px;">
                <div style="display:flex;align-items:center;gap:10px;">
                  <img src='assets/icon.png' alt='앱 아이콘' style='width:32px;height:32px;vertical-align:middle;border-radius:8px;box-shadow:0 1px 4px #00b49a22;'>
                  <span style="font-weight:800;font-size:1.15em;">Pomeranian</span>
                </div>
                <div style="margin:12px 0 0 0;font-size:1.05em;color:#222;text-align:center;">메일 연동 성공!</div>
                <div style="display:flex;gap:18px;margin-top:18px;">
                  <button id="closeSuccessPopup" style="background:#00b49a;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1em;cursor:pointer;">확인</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeSuccessPopup').onclick = () => modal.remove();
            // 3. 저장 후 DB에서 다시 불러와 input에 반영
            const settings = await window.electronAPI.getMailSettings();
            if (settings) {
              if (settings.mailId && document.getElementById('mailIdMain')) document.getElementById('mailIdMain').value = settings.mailId;
              if (settings.mailPw && document.getElementById('mailPwMain')) document.getElementById('mailPwMain').value = settings.mailPw;
              if (settings.host && document.getElementById('hostMain')) document.getElementById('hostMain').value = settings.host;
              if (settings.protocol && document.getElementById('protocolMain')) document.getElementById('protocolMain').value = settings.protocol;
              if (settings.mailSince && document.getElementById('mailSinceMain')) document.getElementById('mailSinceMain').value = settings.mailSince;
            }
          } else {
            alert('메일 연동 실패: ' + (result && result.message ? result.message : '알 수 없는 오류'));
          }
        } catch (err) {
          alert('메일 연동 중 오류: ' + (err && err.message ? err.message : err));
        }
      };

      // 연동정보 자동채움 (DB에서 불러와 input에 값 채우기)
      setTimeout(async () => {
        const settings = await window.electronAPI.getMailSettings();
        if (settings) {
          if (settings.mailId && document.getElementById('mailIdMain')) document.getElementById('mailIdMain').value = settings.mailId;
          if (settings.mailPw && document.getElementById('mailPwMain')) document.getElementById('mailPwMain').value = settings.mailPw;
          if (settings.host && document.getElementById('hostMain')) document.getElementById('hostMain').value = settings.host;
          if (settings.protocol && document.getElementById('protocolMain')) document.getElementById('protocolMain').value = settings.protocol;
          if (settings.mailSince && document.getElementById('mailSinceMain')) document.getElementById('mailSinceMain').value = settings.mailSince;
        }
      }, 100);
    }

    // 실시간 수신
    if (window.electronAPI.onNewTodoAdded) {
      window.electronAPI.onNewTodoAdded(() => refreshAll());
    }
  </script>
</body>
</html>