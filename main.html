<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Main ìœ„ì ¯</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
    }
    .widget-home {
      position: fixed;
      top: 40px;
      left: 40px;
      width: 420px;
      min-height: 540px;
      background: #f8fffd;
      border-radius: 18px;
      box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11;
      overflow: hidden;
      z-index: 10000;
      display: flex;
      flex-direction: column;
    }
    .widget-home-header {
      position: relative;
      height: 64px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: 0 2px 8px #00b49a11;
      font-size: 1.25em;
      font-weight: bold;
      color: #00b49a;
      -webkit-app-region: drag;
      user-select: none;
    }
    .widget-home-header * {
      -webkit-app-region: no-drag;
    }
    .widget-home-sidebar {
      position: absolute;
      top: 64px;
      left: 0;
      width: 54px;
      height: calc(100% - 64px);
      background: #f8fffd;
      box-shadow: 2px 0 8px #00b49a11;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-top: 18px;
      z-index: 2;
    }
    .widget-home-main {
      margin-left: 54px;
      padding: 32px 18px 18px 18px;
      min-height: 400px;
      background: #f8fffd;
      flex: 1;
      z-index: 1;
    }
    .widget-home-sidebar button {
      background: transparent;
      border: none;
      cursor: pointer;
      margin-bottom: 8px;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .widget-home-sidebar svg {
      width: 22px;
      height: 22px;
    }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span style="display:inline-flex;align-items:center;gap:8px;">
        <img src="assets/icon.png" alt="ì•± ì•„ì´ì½˜" style="width:28px;height:28px;vertical-align:middle;margin-right:4px;border-radius:7px;box-shadow:0 1px 4px #00b49a22;" />
        Main
      </span>
      <div>
        <button id="closeBtn" title="ë‹«ê¸°" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <div class="widget-home-sidebar">
      <button title="í™ˆ">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 11.5L12 4l9 7.5" stroke="#00b48a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="6.5" y="11.5" width="11" height="7" rx="2" stroke="#00b48a" stroke-width="2" fill="#e6fff7"/>
        </svg>
      </button>
      <button title="í‚¤ì›Œë“œ ê´€ë¦¬">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="7" width="12" height="6" rx="2" fill="#fff" stroke="#00b48a" stroke-width="1.5"/>
          <rect x="10.5" y="8.5" width="1.2" height="3.5" rx="0.6" fill="#7affe4"/>
        </svg>
      </button>
      <button title="ì´ë©”ì¼ ì—°ë™">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2.5" y="5" width="15" height="10" rx="2" stroke="#00b48a" stroke-width="1.5" fill=""/>
          <path d="M3.5 6l6.5 6 6.5-6" stroke="#00b48a" stroke-width="1.5" fill="none"/>
        </svg>
      </button>
      <button title="í™˜ê²½ì„¤ì •">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 6.5v-2M10 15.5v-2M13.5 10h2M4.5 10h2M13.03 13.03l1.42 1.42M5.55 5.55l1.42 1.42M13.03 6.97l1.42-1.42M5.55 14.45l1.42-1.42" stroke="#00b48a" stroke-width="1.2" stroke-linecap="round"/>
          <circle cx="10" cy="10" r="2.2" stroke="#00b48a" stroke-width="1.2" fill="#e6fff7"/>
        </svg>
      </button>
    </div>
    <div class="widget-home-main" id="widgetHomeMain">
      <h2 id="mainTitle" style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">Main</h2>
      <!-- ìœ„ì ¯ ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    </div>
  </div>
  <script>
    // robust sidebar switching and event binding
    const sidebarBtns = document.querySelectorAll('.widget-home-sidebar button');
    const widgetMain = document.getElementById('widgetHomeMain');

    function renderMainContent(idx) {
      let contentHtml = "";
        if (idx === 0) {
          contentHtml = `
          <h2 id=\"mainTitle\" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>ğŸ  í™ˆ(Home) í™”ë©´</h2>
          <ul id=\"todoCardList\" class=\"schedule-list\" style=\"padding:0;list-style:none;max-width:360px;margin:0 auto;\"></ul>
          <div style='color:#888;font-size:0.98em;margin-top:12px;'>ì˜¤ëŠ˜ì˜ ë©”ì¼ ê¸°ë°˜ í• ì¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <style>
          .schedule-list li.todo-card {
            background:#fff;
            border-radius:10px;
            box-shadow:0 2px 8px #00b49a11;
            padding:16px 18px;
            margin-bottom:12px;
            font-size:1.08em;
            color:#0093b4;
            font-weight:bold;
            transition:box-shadow 0.15s;
          }
          .schedule-list li.todo-card:hover {
            box-shadow:0 4px 16px #00b49a22;
          }
          </style>
          `;
      } else if (idx === 1) {
        contentHtml = `
        <h2 id=\"mainTitle\" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>ğŸ”‘ í‚¤ì›Œë“œ ê´€ë¦¬</h2>
        <div class=\"keyword-input-row\" style=\"width:100%;max-width:360px;display:flex;gap:8px;margin-bottom:12px;\">
          <input type=\"text\" id=\"keywordInput\" class=\"keyword-input\" placeholder=\"í‚¤ì›Œë“œ ì…ë ¥\" style=\"flex:1;padding:6px 8px;border-radius:6px;border:1px solid #7be2c5;\" />
          <button id=\"addKeywordBtn\" class=\"keyword-add-btn\" style=\"background:#e7fffe;color:#00b48a;border:none;padding:6px 18px;border-radius:6px;font-weight:bold;cursor:pointer;transition:background 0.15s;\">ì¶”ê°€</button>
        </div>
        <div id=\"keywordList\" style=\"width:100%;max-width:360px;min-height:32px;margin-bottom:8px;\"></div>
        <div style=\"color:#888;font-size:0.98em;\">ì—¬ê¸°ì„œ í‚¤ì›Œë“œë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        `;
      } else if (idx === 2) {
        contentHtml = `<h2 id="mainTitle" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>ğŸ“§ ì´ë©”ì¼ ëª©ë¡ <span id='emailCount' style='font-size:0.9em;color:#0093b4;'></span></h2><div id='emailListLoading' style='color:#888;margin-bottom:12px;'>ë©”ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div><ul id='emailList' style='padding:0;list-style:none;max-height:420px;overflow-y:auto;border:1px solid #e0e0e0;background:#f8fffd;'></ul>`;
      } else if (idx === 3) {
        contentHtml = `
        <h2 id="mainTitle" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>âš™ï¸ í™˜ê²½ì„¤ì •</h2>
        <form id='mailSettingsForm' style='display:flex;flex-direction:column;gap:18px;align-items:stretch;margin-top:18px;max-width:340px;margin-left:auto;margin-right:auto;'>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ë°©ì‹/ë³´ì•ˆ</label>
            <select id='protocolSecurity' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;'>
              <option value='imap'>IMAP (ì¼ë°˜, 143)</option>
              <option value='imap-secure'>IMAP (SSL, 993)</option>
              <option value='pop3-secure'>POP3 (ë³´ì•ˆ, 995)</option>
              <option value='pop3'>POP3 (ì¼ë°˜, 110)</option>
              <option value='custom'>ì‚¬ìš©ì ì…ë ¥</option>
            </select>
            <div id='customPortDiv' style='display:none;flex-direction:column;gap:8px;margin-top:8px;'>
              <label for='customPort' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>í¬íŠ¸</label>
              <input id='customPort' type='number' placeholder='í¬íŠ¸ë²ˆí˜¸ ì…ë ¥' min='1' max='65535' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
            </div>
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='host' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ì„œë²„</label>
            <input id='host' type='text' placeholder='mail.example.com' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='mailId' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ì•„ì´ë””</label>
            <input id='mailId' type='text' placeholder='user@email.com' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='mailPw' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ë¹„ë°€ë²ˆí˜¸</label>
            <input id='mailPw' type='password' placeholder='ë¹„ë°€ë²ˆí˜¸' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <button type='submit' style='margin-top:10px;background:#00b49a;color:#fff;border:none;padding:10px 36px;border-radius:8px;font-weight:bold;font-size:1.1em;cursor:pointer;box-shadow:0 2px 8px #00b49a22;'>ì €ì¥</button>
        </form>`;
      }
      widgetMain.innerHTML = contentHtml;
        // í™ˆí™”ë©´ í• ì¼ ì¹´ë“œ(ë©”ì¼ ì œëª©ë§Œ) ë Œë”ë§
        if (idx === 0 && window.electronAPI && window.electronAPI.getTodos) {
          window.electronAPI.getTodos().then(res => {
            const cardList = document.getElementById('todoCardList');
            if (!cardList) return;
            if (res && res.length > 0) {
              cardList.innerHTML = res.map(todo => `
                <li class='todo-card'>${todo.task || '(ì œëª© ì—†ìŒ)'}</li>
              `).join('');
            } else {
              cardList.innerHTML = `<li style='color:#bbb;text-align:center;padding:24px 0;'>ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
            }
          });
        }
      if (idx === 2) {
        // ì´ë©”ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        if (window.electronAPI && window.electronAPI.getEmails) {
          window.electronAPI.getEmails().then(emails => {
            const emailList = document.getElementById('emailList');
            const loading = document.getElementById('emailListLoading');
            const emailCount = document.getElementById('emailCount');
            if (loading) loading.style.display = 'none';
            if (emailCount) emailCount.textContent = `(${emails.length})`;
            if (emailList) {
              if (emails && emails.length > 0) {
                emailList.innerHTML = emails.map((mail, idx) => `
                  <li class='email-item' data-idx='${idx}' style='margin-bottom:14px;padding:12px 16px;background:#fff;border-radius:8px;box-shadow:0 2px 8px #00b49a11;position:relative;'>
                    <div style='font-weight:bold;color:#0093b4;'>${mail.subject}</div>
                    <div style='color:#444;font-size:0.98em;margin-top:4px;'>${mail.body ? mail.body.substring(0, 80) + (mail.body.length > 80 ? '...' : '') : ''}</div>
                    <div style='color:#888;font-size:0.92em;margin-top:4px;'>${mail.received_at} / ${mail.from_addr}</div>
                    <button class='add-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#00b49a;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ë¡œ ì¶”ê°€</button>
                  </li>
                `).join('');
                // ìƒì„¸ íŒì—… ì´ë²¤íŠ¸ ì—°ê²°
                document.querySelectorAll('.email-item').forEach(item => {
                  item.querySelector('.add-todo-btn').onclick = function(e) {
                    e.stopPropagation();
                    const mail = emails[parseInt(this.dataset.idx)];
                    if (window.electronAPI && window.electronAPI.addTodoFromMail) {
                      window.electronAPI.addTodoFromMail(mail.id).then(() => {
                        // UI ìƒˆë¡œê³ ì¹¨(ì´ë©”ì¼, í• ì¼ì¹´ë“œ)
                        renderMainContent(2);
                        renderMainContent(0);
                      });
                    }
                  };
                  item.onclick = function(e) {
                    if (e.target.classList.contains('add-todo-btn')) return;
                    const mail = emails[parseInt(this.dataset.idx)];
                    const params = new URLSearchParams({
                      subject: mail.subject,
                      received_at: mail.received_at,
                      from_addr: mail.from_addr,
                      body: mail.body || ''
                    });
                    if (window.electronAPI && window.electronAPI.openMailDetail) {
                      window.electronAPI.openMailDetail(params.toString());
                    } else {
                      window.open('mail-detail.html?' + params.toString(), '_blank', 'width=700,height=600');
                    }
                  };
                });
              } else {
                emailList.innerHTML = `<li style='color:#888;padding:12px;'>ë¶ˆëŸ¬ì˜¨ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
              }
            }
          });
        }
      }
      if (idx === 3) {
        const protoSecSel = document.getElementById('protocolSecurity');
        const customPortDiv = document.getElementById('customPortDiv');
        const mailSettingsForm = document.getElementById('mailSettingsForm');
        protoSecSel.addEventListener('change', function() {
          customPortDiv.style.display = (this.value === 'custom') ? 'flex' : 'none';
        });
        mailSettingsForm.onsubmit = async (e) => {
          e.preventDefault();
          const protocol = document.getElementById('protocolSecurity').value;
          let port = (protocol === 'pop3-secure') ? 995 : document.getElementById('customPort').value;
          const settings = {
            protocol,
            port,
            mailId: document.getElementById('mailId').value,
            mailPw: document.getElementById('mailPw').value,
            host: document.getElementById('host').value
          };
          if (window.electronAPI && window.electronAPI.saveMailSettings) {
            await window.electronAPI.saveMailSettings(settings);
            alert('ë©”ì¼ ì—°ë™ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            alert('Electron í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤.');
            console.log('Saved data:', settings);
          }
        };
      }
    }

    // ìƒì„¸ ë©”ì¼ íŒì—… í•¨ìˆ˜
    function showEmailDetailPopup(mail) {
      // ê¸°ì¡´ íŒì—… ì œê±°
      const oldPopup = document.getElementById('emailDetailPopup');
      if (oldPopup) oldPopup.remove();
      const popup = document.createElement('div');
      popup.id = 'emailDetailPopup';
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(0,0,0,0.18)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '9999';
      popup.innerHTML = `
        <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;max-height:80vh;box-shadow:0 4px 24px #00b49a22;display:flex;flex-direction:column;align-items:flex-start;gap:18px;overflow-y:auto;">
          <div style='font-size:1.15em;font-weight:bold;color:#0093b4;margin-bottom:4px;'>${mail.subject}</div>
          <div style='color:#888;font-size:0.95em;margin-bottom:8px;'>${mail.received_at} / ${mail.from_addr}</div>
          <div style='color:#444;line-height:1.7;white-space:pre-wrap;font-size:1.05em;'>${mail.body ? mail.body : '<i>ë³¸ë¬¸ ì—†ìŒ</i>'}</div>
          <button id='closeEmailDetailPopup' style='margin-top:18px;background:#00b49a;color:#fff;border:none;padding:8px 24px;border-radius:8px;font-size:1em;cursor:pointer;align-self:center;'>ë‹«ê¸°</button>
        </div>
      `;
      document.body.appendChild(popup);
      document.getElementById('closeEmailDetailPopup').onclick = () => popup.remove();
      popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
    }

    // ì´ë²¤íŠ¸ ì—°ê²° ë° ì´ˆê¸°í™”
    sidebarBtns.forEach((btn, idx) => {
      btn.onclick = () => {
        renderMainContent(idx);
      };
    });

    // ë‹«ê¸° ë²„íŠ¼
    document.getElementById('closeBtn').onclick = () => {
      if (window.electronAPI && window.electronAPI.close) {
        window.electronAPI.close();
      } else {
        window.close();
      }
    };

    // ì²« í™”ë©´ ì´ˆê¸°í™”
    renderMainContent(0);

    // ë™ì ìœ¼ë¡œ ì‚½ì…ëœ í‚¤ì›Œë“œ ê´€ë¦¬ ì…ë ¥ë€ ì´ë²¤íŠ¸ ì—°ê²°
    async function loadKeywordsToList() {
      if (!window.electronAPI.getKeywords) return;
      const res = await window.electronAPI.getKeywords();
      const list = document.getElementById('keywordList');
      if (!list) return;
      list.innerHTML = '';
      if(res.success && res.keywords.length > 0) {
        res.keywords.forEach(kw => {
          const div = document.createElement('div');
          div.className = 'keyword-item';
          div.textContent = kw;
          list.appendChild(div);
        });
      } else {
        list.innerHTML = '<div style="color:#bbb;">(ë“±ë¡ëœ í‚¤ì›Œë“œ ì—†ìŒ)</div>';
      }
    }
    function bindKeywordAddEvent() {
      const addBtn = document.getElementById('addKeywordBtn');
      const input = document.getElementById('keywordInput');
      if (addBtn && input) {
        const addKeyword = async () => {
          const kw = input.value.trim();
          if(!kw) return;
          await window.electronAPI.insertKeyword(kw);
          input.value = '';
          await loadKeywordsToList();
          setTimeout(() => {
            input.blur();
            input.focus();
          }, 100);
        };
        addBtn.onclick = addKeyword;
        input.onkeydown = (e) => {
          if (e.key === 'Enter') addKeyword();
        };
      }
    }
    // í™”ë©´ ì „í™˜ ì‹œë§ˆë‹¤ ì´ë²¤íŠ¸ ì—°ê²°
    function afterContentChange(idx) {
      if (idx === 1) {
        bindKeywordAddEvent();
        loadKeywordsToList();
      }
    }
    // sidebar ë²„íŠ¼ í´ë¦­ ì‹œ í™”ë©´ ì „í™˜ ë° ì´ë²¤íŠ¸ ì—°ê²°
    sidebarBtns.forEach((btn, idx) => {
      btn.onclick = () => {
        renderMainContent(idx);
        afterContentChange(idx);
      };
    });
    // ì²« í™”ë©´ ì§„ì… ì‹œ ì´ë²¤íŠ¸ ì—°ê²°
    afterContentChange(0);
  </script>
</body>
</html>
