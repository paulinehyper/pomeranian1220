<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Main 위젯</title>
  <style>
    body { margin: 0; padding: 0; background: transparent; font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; }
    .widget-home { position: fixed; top: 40px; left: 40px; width: 500px; min-height: 540px; background: #f8fffd; border-radius: 18px; box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11; overflow: hidden; z-index: 10000; display: flex; flex-direction: column; }
    .widget-home-header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 2px 8px #00b49a11; font-size: 1.25em; font-weight: bold; color: #00b49a; -webkit-app-region: drag; user-select: none; }
    .widget-home-header * { -webkit-app-region: no-drag; }
    .widget-home-sidebar { position: absolute; top: 64px; left: 0; width: 54px; height: calc(100% - 64px); background: #f8fffd; box-shadow: 2px 0 8px #00b49a11; display: flex; flex-direction: column; align-items: center; gap: 12px; padding-top: 18px; z-index: 2; }
    .widget-home-main { margin-left: 54px; padding: 32px 18px 18px 18px; min-height: 400px; background: #f8fffd; flex: 1; z-index: 1; overflow-y: auto; }
    
    .widget-home-sidebar button { background: transparent; border: none; cursor: pointer; margin-bottom: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background 0.2s; }
    .widget-home-sidebar button:hover { background: #e6fff7; }
    .widget-home-sidebar svg { width: 22px; height: 22px; }

    /* 할일 카드 스타일 */
    .todo-card { background: #fff; border-radius: 10px; padding: 12px 16px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0, 180, 154, 0.1); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #00b49a; }
    .todo-content { font-weight: 500; color: #333; }
    .todo-date { font-size: 0.8em; color: #999; }
    
    /* 키워드 스타일 */
    .keyword-item { display: inline-block; background: #e7fffe; color: #00b48a; padding: 6px 12px; border-radius: 20px; margin: 4px; border: 1px solid #7be2c5; font-size: 0.9em; font-weight: bold; }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span style="display:inline-flex;align-items:center;gap:8px;">
        <img src="assets/icon.png" alt="앱 아이콘" style="width:28px;height:28px;border-radius:7px;" />
        Main
      </span>
      <button id="closeBtn" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">×</button>
    </div>

    <div class="widget-home-sidebar">
      <button title="홈" data-type="main">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
      <button title="키워드 관리" data-type="keyword">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="13" y2="17"/></svg>
      </button>
      <button title="환경설정" data-type="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <div style="flex:1;"></div>
      <button title="휴지통" data-type="trash" style="margin-bottom:16px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
      </button>
    </div>

    <div class="widget-home-main" id="widgetHomeMain"></div>
  </div>

  <script>
    window.onload = function() {
      const widgetMain = document.getElementById('widgetHomeMain');
      const sidebarBtns = document.querySelectorAll('.widget-home-sidebar button');

      // [공통] 목록 갱신 함수 (어디서든 호출 가능하도록 상위 스코프에 배치)
      async function refreshTodos() {
        const container = document.getElementById('todoListContainer');
        if (!container) return; // 메인 화면이 아닐 경우 중단

        if (window.electronAPI && window.electronAPI.getTodos) {
          try {
            const todos = await window.electronAPI.getTodos();
            console.log("Fetched todos:", todos);
            container.innerHTML = (todos && todos.length) 
              ? todos.map(t => `
                  <div class="todo-card">
                    <span class="todo-content">${t.task}</span>
                    <span class="todo-date">${new Date().toLocaleDateString()}</span>
                  </div>`).join('')
              : '<p style="color:#bbb; text-align:center; padding-top:20px;">할일이 없습니다.</p>';
          } catch (err) {
            console.error("Failed to load todos:", err);
          }
        }
      }

      // 1. 화면 렌더링 함수
      async function renderMainContent(type) {
        let contentHtml = "";

        if (type === 'main') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">할일 목록</h2>
            <div style="display:flex;gap:8px;margin-bottom:20px;">
              <input type="text" id="todoInput" placeholder="할일을 입력하세요" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;outline:none;">
              <button id="addTodoBtn" style="background:#00b49a;color:#fff;border:none;padding:0 20px;border-radius:8px;font-weight:bold;cursor:pointer;">추가</button>
            </div>
            <div id="todoListContainer">로딩 중...</div>`;
        } 
        else if (type === 'keyword') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">키워드 관리</h2>
            <div style="display:flex;gap:8px;margin-bottom:20px;">
              <input type="text" id="keywordInput" placeholder="새 키워드" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;outline:none;">
              <button id="addKeywordBtn" style="background:#00b49a;color:#fff;border:none;padding:0 20px;border-radius:8px;font-weight:bold;cursor:pointer;">등록</button>
            </div>
            <div id="keywordListContainer">로딩 중...</div>`;
        } 
        else if (type === 'settings') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">환경설정</h2>
            <form id="settingsForm" style="display:flex;flex-direction:column;gap:15px;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">메일 서버</label>
                <input type="text" id="host" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">아이디</label>
                <input type="text" id="mailId" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">비밀번호</label>
                <input type="password" id="mailPw" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <button type="submit" style="background:#00b49a;color:#fff;border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:10px;">저장하기</button>
            </form>`;
        }
        else {
          contentHtml = `<h2 style="color:#00b49a;">${type} 페이지</h2><p style="color:#888;">준비 중입니다.</p>`;
        }

        widgetMain.innerHTML = contentHtml;
        // HTML이 DOM에 삽입된 후 로직 연결
        initPageLogic(type);
      }

      // 2. 페이지별 로직 초기화
      function initPageLogic(type) {
        if (type === 'main') {
          const input = document.getElementById('todoInput');
          const addBtn = document.getElementById('addTodoBtn');

          if (!addBtn || !input) return;

          // 추가 버튼 클릭 이벤트
          addBtn.onclick = async () => {
            const val = input.value.trim();
            if (!val) return;
            
            console.log("Attempting to add todo:", val);

            if (window.electronAPI && window.electronAPI.insertTodo) {
              try {
                // main.js의 insert-todo 핸들러는 { task, deadline, memo }를 기대함
                const res = await window.electronAPI.insertTodo({ task: val });
                console.log("Insert result:", res);
                
                if (res === true || (res && res.success)) {
                  input.value = '';
                  await refreshTodos();
                } else {
                  console.warn("Insert failed or returned unexpected result:", res);
                  await refreshTodos();
                }
              } catch (err) {
                console.error("IPC Error during insertTodo:", err);
              }
            }
          };

          input.onkeypress = (e) => { if(e.key === 'Enter') addBtn.click(); };
          refreshTodos();
        }

        // 키워드 관리 로직
        if (type === 'keyword') {
          const input = document.getElementById('keywordInput');
          const addBtn = document.getElementById('addKeywordBtn');
          const container = document.getElementById('keywordListContainer');

          const refreshKeywords = async () => {
            if (window.electronAPI && window.electronAPI.getKeywords) {
              const keywords = await window.electronAPI.getKeywords();
              container.innerHTML = (keywords && keywords.length)
                ? keywords.map(k => `<span class="keyword-item">${k}</span>`).join('')
                : '<p style="color:#bbb;">등록된 키워드가 없습니다.</p>';
            }
          };

          addBtn.onclick = async () => {
            const val = input.value.trim();
            if (!val) return;
            if (window.electronAPI && window.electronAPI.insertKeyword) {
              await window.electronAPI.insertKeyword(val);
              input.value = '';
              await refreshKeywords();
            }
          };
          refreshKeywords();
        }

        // 환경 설정 로직
        if (type === 'settings') {
          const form = document.getElementById('settingsForm');
          // 기존 데이터 로드 로직... (이하 동일)
        }
      }

      // [추가] 외부에서 할일 추가 알림을 받을 때 (메일 동기화 등)
      if (window.electronAPI && window.electronAPI.onNewTodoAdded) {
        window.electronAPI.onNewTodoAdded(() => {
          console.log("External todo added, refreshing...");
          refreshTodos();
        });
      }

      sidebarBtns.forEach(btn => {
        btn.onclick = () => renderMainContent(btn.getAttribute('data-type'));
      });

      document.getElementById('closeBtn').onclick = () => {
        if (window.electronAPI) window.electronAPI.close();
      };

      // 초기 실행
      renderMainContent('main');
    };
  </script>
</body>
</html>