<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Main 위젯</title>
  <style>
    body { margin: 0; padding: 0; background: transparent; font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; }
    .widget-home { position: fixed; top: 40px; left: 40px; width: 520px; min-height: 560px; background: #f8fffd; border-radius: 18px; box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11; overflow: hidden; display: flex; flex-direction: column; }
    .widget-home-header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 2px 8px #00b49a11; font-size: 1.25em; font-weight: bold; color: #00b49a; -webkit-app-region: drag; }
    .widget-home-header * { -webkit-app-region: no-drag; }
    
    .widget-home-sidebar { position: absolute; top: 64px; left: 0; width: 56px; height: calc(100% - 64px); background: #ffffff; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; gap: 16px; padding-top: 20px; z-index: 2; }
    .sidebar-btn { background: transparent; border: none; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #00b49a; transition: 0.2s; }
    .sidebar-btn:hover { background: #e6fffb; }
    .sidebar-btn svg { width: 22px; height: 22px; stroke: currentColor; }

    .widget-home-main { margin-left: 56px; padding: 24px 18px; flex: 1; overflow-y: auto; background: #f8fffd; }
    
    /* [핵심] 할일 카드 및 취소선 스타일 */
    .todo-card { position: relative; background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0, 180, 154, 0.08); border-left: 5px solid #00b49a; transition: 0.2s; cursor: pointer; user-select: none; }
    
    /* 완료 상태 (flag=2) CSS */
    .todo-card.completed { border-left-color: #bbb !important; background: #f2f2f2 !important; opacity: 0.7; }
    .todo-card.completed .todo-content { 
      text-decoration: line-through !important; 
      text-decoration-color: #00b49a !important; 
      color: #888 !important; 
    }

    .delete-btn { position: absolute; top: 12px; right: 12px; display: none; background: transparent; border: none; cursor: pointer; color: #00b49a; }
    .todo-card.completed .delete-btn { display: flex; }

    .todo-top { display: flex; justify-content: space-between; align-items: flex-start; padding-right: 35px; }
    .todo-content { font-weight: 600; color: #333; font-size: 1.05em; transition: 0.2s; }
    
    .todo-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .todo-date { font-size: 0.82em; color: #777; background: #f0fcf9; padding: 2px 8px; border-radius: 4px; }
    .d-day-badge { font-size: 0.75em; font-weight: bold; padding: 3px 8px; border-radius: 6px; color: #fff; }
    .d-day-active { background: #00b49a; }
    .d-day-urgent { background: #ff5e5e; }
    .d-day-passed { background: #ddd; color: #777; }

    .input-section { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eef2f1; }
    .input-row { display: flex; gap: 6px; }
    .todo-input { flex: 1; padding: 10px; border-radius: 8px; border: 1.5px solid #7be2c5; outline: none; }
    .date-input { width: 40px; border-radius: 8px; border: 1.5px solid #7be2c5; cursor: pointer; }
    .add-btn { background: #00b49a; color: #fff; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span>Main</span>
      <button id="closeBtn" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">&times;</button>
    </div>

    <div class="widget-home-sidebar">
      <button class="sidebar-btn" title="홈" data-type="main">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
      <button class="sidebar-btn" title="키워드" data-type="keyword">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3-3.5 3.5z"/></svg>
      </button>
      <button class="sidebar-btn" title="설정" data-type="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>

    <div class="widget-home-main" id="widgetHomeMain"></div>
  </div>

  <script>
    window.onload = function() {
      const widgetMain = document.getElementById('widgetHomeMain');
      const sidebarBtns = document.querySelectorAll('.sidebar-btn');

      function getDDay(deadline) {
        if (!deadline) return null;
        const today = new Date(); today.setHours(0,0,0,0);
        const target = new Date(deadline); target.setHours(0,0,0,0);
        const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        if (diffDays === 0) return { text: "오늘까지", class: "d-day-urgent" };
        if (diffDays > 0) return { text: `D-${diffDays}`, class: diffDays <= 3 ? "d-day-urgent" : "d-day-active" };
        return { text: `지남`, class: "d-day-passed" };
      }

      async function refreshTodos() {
        const container = document.getElementById('todoListContainer');
        if (!container || !window.electronAPI) return;
        try {
          const todos = await window.electronAPI.getTodos();
          container.innerHTML = (todos && todos.length) ? todos.map(t => {
            const dday = t.deadline ? getDDay(t.deadline) : null;
            const isDone = Number(t.todo_flag) === 2;
            return `
              <div class="todo-card${isDone ? ' completed' : ''}" data-id="${t.id}">
                <div class="todo-top">
                  <span class="todo-content" style="${isDone ? 'text-decoration:line-through;color:#888;' : ''}">${t.task || t.content}</span>
                  ${dday && !isDone ? `<span class="d-day-badge ${dday.class}">${dday.text}</span>` : ''}
                  <button class="delete-btn" style="display:${isDone ? 'flex' : 'none'};background:transparent;border:none;cursor:pointer;margin-left:8px;padding:0;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#00b49a" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      <line x1="10" y1="11" x2="10" y2="17"/>
                      <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                  </button>
                </div>
                <div class="todo-bottom">
                  <span class="todo-date">${t.deadline ? '마감: ' + t.deadline : '기한 없음'}</span>
                </div>
              </div>`;
          }).join('') : '<p style="text-align:center;color:#bbb;padding-top:20px;">할일이 없습니다.</p>';

          // 제목 클릭 시 취소선/휴지통 토글
          document.querySelectorAll('.todo-card').forEach(card => {
            const content = card.querySelector('.todo-content');
            const delBtn = card.querySelector('.delete-btn');
            content.onclick = function(e) {
              if (delBtn.style.display === 'flex') {
                content.style.textDecoration = '';
                content.style.color = '';
                delBtn.style.display = 'none';
              } else {
                content.style.textDecoration = 'line-through';
                content.style.color = '#888';
                delBtn.style.display = 'flex';
              }
            };
            delBtn.onclick = async function(e) {
              e.stopPropagation();
              const id = card.getAttribute('data-id');
              if (window.electronAPI && window.electronAPI.setTodoComplete) {
                await window.electronAPI.setTodoComplete(Number(id), 2); // 2: 삭제(완료)
                await refreshTodos();
              }
            };
          });
        } catch (err) { console.error(err); }
      }

      let pressTimer;
      window.startPress = (e, id, currentFlag) => {
        // 좌클릭이 아니거나 휴지통 클릭 시 무시
        if(e.button !== 0 || e.target.closest('.delete-btn')) return;
        
        pressTimer = setTimeout(async () => {
          const newFlag = (Number(currentFlag) === 2) ? 1 : 2;
          if (window.electronAPI.setTodoComplete) {
            await window.electronAPI.setTodoComplete(Number(id), newFlag);
            await refreshTodos(); // 변경된 상태로 목록 다시 그리기
          }
        }, 800);
      };
      window.endPress = () => clearTimeout(pressTimer);

      window.handleDelete = async (e, id) => {
        e.stopPropagation();
        if (confirm("완전히 삭제하시겠습니까?")) {
          await window.electronAPI.excludeTodo(Number(id));
          await refreshTodos();
        }
      };

      async function renderMainContent(type) {
        if (type === 'main') {
          widgetMain.innerHTML = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.1em;font-weight:800;">할일 목록</h2>
            <div class="input-section">
              <div class="input-row">
                <input type="text" id="todoInput" class="todo-input" placeholder="할일을 입력하세요...">
                <input type="date" id="deadlineInput" class="date-input">
                <button id="addTodoBtn" class="add-btn">추가</button>
              </div>
            </div>
            <div id="todoListContainer"></div>`;
          
          document.getElementById('addTodoBtn').onclick = async () => {
            const input = document.getElementById('todoInput');
            const date = document.getElementById('deadlineInput');
            if (!input.value.trim()) return;
            await window.electronAPI.insertTodo({ task: input.value, deadline: date.value || null });
            input.value = ''; date.value = '';
            refreshTodos();
          };
          refreshTodos();
        } else {
          widgetMain.innerHTML = `<h2 style="color:#00b49a;font-size:1.1em;">${type} 페이지</h2>`;
        }
      }

      sidebarBtns.forEach(btn => btn.onclick = () => renderMainContent(btn.getAttribute('data-type')));
      document.getElementById('closeBtn').onclick = () => window.electronAPI.close();
      renderMainContent('main');
    };
  </script>
</body>
</html>