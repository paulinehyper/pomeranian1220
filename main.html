<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Main 위젯</title>
  <style>
    body { margin: 0; padding: 0; background: transparent; font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; }
    .widget-home { position: fixed; top: 40px; left: 40px; width: 520px; min-height: 560px; background: #f8fffd; border-radius: 18px; box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11; overflow: hidden; z-index: 10000; display: flex; flex-direction: column; }
    .widget-home-header { height: 64px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 2px 8px #00b49a11; font-size: 1.25em; font-weight: bold; color: #00b49a; -webkit-app-region: drag; user-select: none; }
    .widget-home-header * { -webkit-app-region: no-drag; }
    .widget-home-sidebar { position: absolute; top: 64px; left: 0; width: 54px; height: calc(100% - 64px); background: #f8fffd; box-shadow: 2px 0 8px #00b49a11; display: flex; flex-direction: column; align-items: center; gap: 12px; padding-top: 18px; z-index: 2; }
    .widget-home-main { margin-left: 54px; padding: 24px 18px 18px 18px; min-height: 400px; background: #f8fffd; flex: 1; z-index: 1; overflow-y: auto; }
    
    .widget-home-sidebar button { background: transparent; border: none; cursor: pointer; margin-bottom: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background 0.2s; }
    .widget-home-sidebar button:hover { background: #e6fff7; }
    .widget-home-sidebar svg { width: 22px; height: 22px; }

    /* 할일 카드 스타일 */
    .todo-card { background: #fff; border-radius: 12px; padding: 14px 16px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0, 180, 154, 0.08); display: flex; flex-direction: column; gap: 6px; border-left: 5px solid #00b49a; transition: transform 0.2s; }
    .todo-card:hover { transform: translateY(-2px); }
    .todo-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .todo-content { font-weight: 600; color: #333; font-size: 1.05em; }
    .todo-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
    .todo-date { font-size: 0.85em; color: #777; background: #f0fcf9; padding: 2px 8px; border-radius: 4px; }
    .d-day-badge { font-size: 0.8em; font-weight: bold; padding: 3px 8px; border-radius: 6px; }
    .d-day-active { background: #00b49a; color: #fff; }
    .d-day-urgent { background: #ff5e5e; color: #fff; }
    .d-day-passed { background: #ddd; color: #777; }

    /* 입력 폼 스타일 */
    .input-section { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.03); border: 1px solid #eef2f1; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .todo-input { flex: 1; padding: 10px; border-radius: 8px; border: 1.5px solid #7be2c5; outline: none; }
    .date-input { width: 140px; padding: 8px; border-radius: 8px; border: 1.5px solid #7be2c5; color: #555; cursor: pointer; }
    .add-btn { background: #00b49a; color: #fff; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
    .add-btn:hover { background: #00937e; }
    
    .keyword-item { display: inline-block; background: #e7fffe; color: #00b48a; padding: 6px 12px; border-radius: 20px; margin: 4px; border: 1px solid #7be2c5; font-size: 0.9em; font-weight: bold; }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span style="display:inline-flex;align-items:center;gap:8px;">
        <img src="assets/icon.png" alt="앱 아이콘" style="width:28px;height:28px;border-radius:7px;" />
        Main
      </span>
      <button id="closeBtn" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">×</button>
    </div>

    <div class="widget-home-sidebar">
      <button title="홈" data-type="main">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
      <button title="키워드 관리" data-type="keyword">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="13" y2="17"/></svg>
      </button>
      <button title="환경설정" data-type="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <div style="flex:1;"></div>
      <button title="휴지통" data-type="trash" style="margin-bottom:16px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00b48a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
      </button>
    </div>

    <div class="widget-home-main" id="widgetHomeMain"></div>
  </div>

  <script>
    window.onload = function() {
      const widgetMain = document.getElementById('widgetHomeMain');
      const sidebarBtns = document.querySelectorAll('.widget-home-sidebar button');

      // [D-Day 계산 함수]
      function getDDay(deadline) {
        if (!deadline) return "";
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const target = new Date(deadline);
        target.setHours(0, 0, 0, 0);
        
        const diffTime = target - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return { text: "오늘까지", class: "d-day-urgent" };
        if (diffDays > 0) return { text: `D-${diffDays}`, class: diffDays <= 3 ? "d-day-urgent" : "d-day-active" };
        return { text: `지남`, class: "d-day-passed" };
      }

      // [공통] 목록 갱신 함수
      async function refreshTodos() {
        const container = document.getElementById('todoListContainer');
        if (!container) return;

        if (window.electronAPI && window.electronAPI.getTodos) {
          try {
            const todos = await window.electronAPI.getTodos();
            container.innerHTML = (todos && todos.length) 
              ? todos.map(t => {
                  const dday = t.deadline ? getDDay(t.deadline) : null;
                  return `
                  <div class="todo-card">
                    <div class="todo-top">
                      <span class="todo-content">${t.task || t.content}</span>
                      ${dday ? `<span class="d-day-badge ${dday.class}">${dday.text}</span>` : ''}
                    </div>
                    <div class="todo-bottom">
                      <span class="todo-date">${t.deadline ? '마감: ' + t.deadline : '기한 없음'}</span>
                    </div>
                  </div>`;
                }).join('')
              : '<p style="color:#bbb; text-align:center; padding-top:20px;">할일이 없습니다.</p>';
          } catch (err) {
            console.error("Failed to load todos:", err);
          }
        }
      }

      // 1. 화면 렌더링 함수
      async function renderMainContent(type) {
        let contentHtml = "";

        if (type === 'main') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">할일 목록</h2>
            <div class="input-section">
              <div class="input-row">
                <input type="text" id="todoInput" class="todo-input" placeholder="할일을 입력하세요">
                <button id="addTodoBtn" class="add-btn">추가</button>
              </div>
              <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.85em; color:#666;">마감 날짜:</span>
                <input type="date" id="deadlineInput" class="date-input">
              </div>
            </div>
            <div id="todoListContainer">로딩 중...</div>`;
        } 
        else if (type === 'keyword') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">키워드 관리</h2>
            <div style="display:flex;gap:8px;margin-bottom:20px;">
              <input type="text" id="keywordInput" placeholder="새 키워드" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;outline:none;">
              <button id="addKeywordBtn" class="add-btn">등록</button>
            </div>
            <div id="keywordListContainer">로딩 중...</div>`;
        } 
        else if (type === 'settings') {
          contentHtml = `
            <h2 style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">환경설정</h2>
            <form id="settingsForm" style="display:flex;flex-direction:column;gap:15px;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">메일 서버</label>
                <input type="text" id="host" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">아이디</label>
                <input type="text" id="mailId" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;color:#0093b4;">비밀번호</label>
                <input type="password" id="mailPw" style="width:100%;padding:10px;border-radius:8px;border:1.5px solid #7be2c5;box-sizing:border-box;">
              </div>
              <button type="submit" class="add-btn" style="padding:12px; margin-top:10px;">저장하기</button>
            </form>`;
        }

        widgetMain.innerHTML = contentHtml;
        initPageLogic(type);
      }

      // 2. 페이지별 로직 초기화
      function initPageLogic(type) {
        if (type === 'main') {
          const input = document.getElementById('todoInput');
          const dateInput = document.getElementById('deadlineInput');
          const addBtn = document.getElementById('addTodoBtn');

          // 오늘 날짜를 기본값으로 설정 (선택 사항)
          // dateInput.value = new Date().toISOString().substring(0, 10);

          addBtn.onclick = async () => {
            const val = input.value.trim();
            const deadline = dateInput.value;
            if (!val) return;
            
            if (window.electronAPI && window.electronAPI.insertTodo) {
              try {
                // task와 deadline을 함께 전송
                const res = await window.electronAPI.insertTodo({ 
                  task: val, 
                  deadline: deadline || null 
                });
                
                if (res === true || (res && res.success)) {
                  input.value = '';
                  dateInput.value = '';
                  await refreshTodos();
                }
              } catch (err) {
                console.error("IPC Error:", err);
              }
            }
          };

          input.onkeypress = (e) => { if(e.key === 'Enter') addBtn.click(); };
          refreshTodos();
        }

        if (type === 'keyword') {
          const input = document.getElementById('keywordInput');
          const addBtn = document.getElementById('addKeywordBtn');
          const container = document.getElementById('keywordListContainer');

          const refreshKeywords = async () => {
            if (window.electronAPI && window.electronAPI.getKeywords) {
              const keywords = await window.electronAPI.getKeywords();
              container.innerHTML = (keywords && keywords.length)
                ? keywords.map(k => `<span class="keyword-item">${k}</span>`).join('')
                : '<p style="color:#bbb;">등록된 키워드가 없습니다.</p>';
            }
          };

          addBtn.onclick = async () => {
            const val = input.value.trim();
            if (!val) return;
            await window.electronAPI.insertKeyword(val);
            input.value = '';
            await refreshKeywords();
          };
          refreshKeywords();
        }
      }

      sidebarBtns.forEach(btn => {
        btn.onclick = () => renderMainContent(btn.getAttribute('data-type'));
      });

      document.getElementById('closeBtn').onclick = () => {
        if (window.electronAPI) window.electronAPI.close();
      };

      renderMainContent('main');
    };
  </script>
</body>
</html>